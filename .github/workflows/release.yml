name: Build & Release InfluxDB3 Unlocked  
  
on:  
  workflow_dispatch:  
  
permissions:  
  contents: write  
  packages: write  
  
env:  
  CARGO_INCREMENTAL: "yes"  
  CARGO_NET_GIT_FETCH_WITH_CLI: "false"  
  PROFILE: "release"  
  FEATURES: "aws,gcp,azure,jemalloc_replacing_malloc"  
  PACKAGE: "influxdb3"  
  PBS_DATE: "unset"  
  PBS_VERSION: "unset"  
  
jobs:  
  build-binary:  
    name: Build Binary (${{ matrix.arch }})  
    runs-on: ubuntu-latest  
    strategy:  
      matrix:  
        include:  
          - target: x86_64-unknown-linux-gnu  
            arch: amd64  
          - target: aarch64-unknown-linux-gnu  
            arch: arm64  
    outputs:  
      version: ${{ env.VERSION }}  
    steps:  
      - name: Checkout code  
        uses: actions/checkout@v4  
        with:  
          repository: refluxdb/refluxdb  
          ref: main  
  
      - name: Install Rust  
        uses: dtolnay/rust-toolchain@stable  
        with:  
          targets: ${{ matrix.target }}  
  
      - name: Cache Rust dependencies  
        uses: actions/cache@v3  
        with:  
          path: |  
            ~/.cargo/registry  
            ~/.cargo/git  
            target  
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}  
          restore-keys: |  
            ${{ runner.os }}-cargo-${{ matrix.target }}-  
            ${{ runner.os }}-cargo-  
  
      - name: Install dependencies  
        run: |  
          sudo apt update  
          sudo apt install -y binutils build-essential curl pkg-config libssl-dev clang lld git patchelf protobuf-compiler zstd libz-dev python3-dev python3-pip  
          if [ "${{ matrix.target }}" = "aarch64-unknown-linux-gnu" ]; then  
            sudo apt install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu  
          fi  
  
      - name: Build binary  
        run: |  
          cargo build --package="$PACKAGE" --profile="$PROFILE" --target="${{ matrix.target }}" --no-default-features --features="$FEATURES"  
          objcopy --compress-debug-sections "target/${{ matrix.target }}/$PROFILE/$PACKAGE"  
        env:  
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc  
  
      - name: Extract version  
        run: |  
          VERSION=$(file "target/${{ matrix.target }}/$PROFILE/$PACKAGE" | grep -q "ARM aarch64" && echo "cross-compiled" || ./target/${{ matrix.target }}/$PROFILE/$PACKAGE --version | cut -d' ' -f2 | cut -d',' -f1)  
          if [ "$VERSION" = "cross-compiled" ]; then  
            VERSION=$(strings "target/${{ matrix.target }}/$PROFILE/$PACKAGE" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+' | head -1)  
          fi  
          echo "VERSION=$VERSION" >> $GITHUB_ENV  
          echo "Extracted version: $VERSION"  
  
      - name: Create release archive  
        run: |  
          mkdir -p release  
          cp "./target/${{ matrix.target }}/$PROFILE/$PACKAGE" release/influxdb3-${{ matrix.arch }}  
  
      - name: Upload binary artifact  
        uses: actions/upload-artifact@v4  
        with:  
          name: influxdb3-${{ matrix.arch }}  
          path: ./release/influxdb3-${{ matrix.arch }}  
          retention-days: 1  
  
      - name: Release  
        uses: softprops/action-gh-release@v2  
        if: github.ref_type == 'tag'  
        with:  
          files: |  
            ./release/influxdb3-${{ matrix.arch }}  
              
  build-docker:  
    name: Build and Push Docker Image  
    runs-on: ubuntu-latest  
    needs: build-binary  
    steps:  
      - name: Checkout code  
        uses: actions/checkout@v4  
        with:  
          repository: refluxdb/refluxdb  
          ref: main  
  
      - name: Download AMD64 binary  
        uses: actions/download-artifact@v4  
        with:  
          name: influxdb3-amd64  
          path: ./binary-amd64  
  
      - name: Download ARM64 binary  
        uses: actions/download-artifact@v4  
        with:  
          name: influxdb3-arm64  
          path: ./binary-arm64  
  
      - name: Prepare binaries for Docker  
        run: |  
          mkdir -p binary  
          mv binary-amd64/influxdb3-amd64 binary/influxdb3-amd64  
          mv binary-arm64/influxdb3-arm64 binary/influxdb3-arm64  
          chmod +x binary/influxdb3-*  
  
      - name: Log in to the GHCR registry  
        uses: docker/login-action@v3.4.0  
        with:  
          registry: ghcr.io  
          username: ${{ github.actor }}  
          password: ${{ secrets.GITHUB_TOKEN }}  
  
      - name: Set up Docker Buildx  
        uses: docker/setup-buildx-action@v3.11.1  
  
      - name: Docker Build and push  
        uses: docker/build-push-action@v6.18.0  
        with:  
          context: .  
          file: ./docker/Dockerfile.prebuilt  
          push: true  
          platforms: linux/amd64,linux/arm64  
          tags: |  
            ghcr.io/refluxdb/influxdb3-unlocked:latest  
            ghcr.io/refluxdb/refluxdb:latest  
            ghcr.io/refluxdb/refluxdb:${{ needs.build-binary.outputs.version }}  
          build-args: |  
            PACKAGE=influxdb3  
          cache-from: type=gha  
          cache-to: type=gha,mode=max

